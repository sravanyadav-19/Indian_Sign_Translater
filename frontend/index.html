<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISL Learning Hub</title>
    <style>
        /* Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #f4f7fa;
            --card-bg: rgba(255, 255, 255, 0.5);
            --card-border: rgba(255, 255, 255, 0.8);
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --primary-accent: #8e44ad; /* Changed to a nice purple */
            --primary-glow: rgba(142, 68, 173, 0.5);
            --success-color: #2ecc71;
            --header-bg: rgba(255, 255, 255, 0.4);
            --log-bg: rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --bg-color: #0d1117;
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-border: rgba(56, 73, 99, 0.8);
            --text-color: #e6edf3;
            --text-light: #bdc3c7;
            --primary-accent: #9b59b6;
            --primary-glow: rgba(155, 89, 182, 0.5);
            --header-bg: rgba(30, 41, 59, 0.3);
            --log-bg: rgba(255,255,255,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-y: hidden;
        }

        /* --- Animated Background & Header (Same as before) --- */
        .gradient-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; }
        .gradient-bg .blob { position: absolute; border-radius: 50%; filter: blur(90px); }
        .blob1 { width: 500px; height: 500px; background: #9b59b6; top: -200px; left: -200px; animation: move 25s infinite alternate; }
        .blob2 { width: 350px; height: 350px; background: #3498db; bottom: -150px; right: -150px; animation: move 30s infinite alternate; }
        @keyframes move { from { transform: translate(0, 0) rotate(0deg); } to { transform: translate(150px, 80px) rotate(180deg); } }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; position: sticky; top: 0; z-index: 10; background: var(--header-bg); border-bottom: 1px solid var(--card-border); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .header-title { display: flex; align-items: center; font-size: 1.5rem; font-weight: 600; }
        .header-icon { font-size: 1.8rem; margin-right: 0.75rem; }
        .theme-switch { display: flex; align-items: center; cursor: pointer; }
        .theme-switch input { display: none; }
        .slider { width: 50px; height: 26px; background-color: #ccc; border-radius: 13px; position: relative; transition: 0.3s; }
        .slider:before { content: ""; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* --- Main Layout: Grid --- */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 0.7fr;
            gap: 2rem;
            padding: 2rem;
            height: calc(100vh - 75px); /* Full height minus header */
        }
        
        .panel {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        /* --- Left Panel: Live Detection --- */
        .live-panel { align-items: center; justify-content: center; }
        .webcam-wrapper {
            position: relative;
            width: 100%;
            max-width: 90vh; /* Maintain aspect ratio */
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }
        .webcam-wrapper.scanning { border-color: var(--primary-accent); animation: pulse 2s infinite; }
        #webcam { display: block; width: 100%; height: auto; transform: scaleX(-1); }
        #floating-prediction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 3rem;
            font-weight: 700;
            text-transform: capitalize;
            padding: 0.5rem 2rem;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #floating-prediction.visible { opacity: 1; animation: pop-up 0.5s ease-out; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 70% { box-shadow: 0 0 15px 10px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        @keyframes pop-up { from { transform: translateX(-50%) translateY(20px) scale(0.8); opacity: 0; } to { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; } }

        /* --- Right Panel: Results & Learning --- */
        .results-panel { gap: 1.5rem; }
        .card-header { font-size: 1.2rem; font-weight: 600; padding-bottom: 0.5rem; }
        #translate-form { display: flex; gap: 0.5rem; }
        #text-input { flex-grow: 1; padding: 0.6rem 1rem; border: none; background: var(--log-bg); border-radius: 8px; font-size: 1rem; color: var(--text-color); }
        #translate-btn { padding: 0.6rem 1.2rem; border: none; background-color: var(--primary-accent); color: white; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        
        #playback-video-container { background-color: #000; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 200px; }
        #playback-video { width: 100%; display: none; }
        #video-placeholder { color: var(--text-light); }

        #detection-log-wrapper { flex-grow: 1; overflow-y: auto; }
        #detection-log { list-style: none; }
        .log-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--log-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slide-in 0.5s ease-out;
        }
        .log-text { font-size: 1.1rem; font-weight: 500; text-transform: capitalize; }
        .log-time { font-size: 0.8rem; color: var(--text-light); }
        .play-log-btn { background: none; border: none; cursor: pointer; }
        @keyframes slide-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    </style>
</head>
<body>
    <div class="gradient-bg"><div class="blob blob1"></div><div class="blob blob2"></div></div>

    <header class="header">
        <div class="header-title"><span class="header-icon">âœ¨</span>ISL Learning Hub</div>
        <label class="theme-switch" for="theme-toggle"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label>
    </header>

    <main class="main-container">
        <!-- LEFT PANEL: LIVE DETECTION -->
        <div class="panel live-panel">
            <div class="webcam-wrapper" id="webcam-wrapper">
                <video id="webcam" autoplay playsinline></video>
                <div id="floating-prediction"></div>
            </div>
        </div>

        <!-- RIGHT PANEL: RESULTS & LEARNING -->
        <div class="panel results-panel">
            <div>
                <h2 class="card-header">Text-to-Sign Translator</h2>
                <form id="translate-form">
                    <input type="text" id="text-input" placeholder="Enter word to see sign..." required>
                    <button type="submit" id="translate-btn">Show</button>
                </form>
            </div>

            <div id="playback-video-container">
                <video id="playback-video" controls></video>
                <span id="video-placeholder">Video appears here</span>
            </div>

            <div id="detection-log-wrapper">
                <h2 class="card-header">Detection Log</h2>
                <ul id="detection-log"></ul>
            </div>
        </div>
    </main>

    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        // --- DOM Elements ---
        const themeToggle = document.getElementById('theme-toggle');
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const floatingPrediction = document.getElementById('floating-prediction');
        const webcamWrapper = document.getElementById('webcam-wrapper');
        const translateForm = document.getElementById('translate-form');
        const textInput = document.getElementById('text-input');
        const playbackVideo = document.getElementById('playback-video');
        const videoPlaceholder = document.getElementById('video-placeholder');
        const detectionLog = document.getElementById('detection-log');
        let lastDetectedWord = '';
        let detectedWordsSet = new Set(); // To avoid duplicate log entries

        // --- Theme Manager ---
        themeToggle.addEventListener('change', function() {
            document.body.classList.toggle('dark-mode', this.checked);
            localStorage.setItem('theme', this.checked ? 'dark-mode' : 'light');
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.classList.add(savedTheme);
            themeToggle.checked = savedTheme === 'dark-mode';
        }

        // --- Core Functions ---
        function playSignVideo(word) {
            const videoSrc = `signs/${word.toLowerCase().replace(/\s/g, '')}.mp4`;
            playbackVideo.src = videoSrc;
            videoPlaceholder.style.display = 'none';
            playbackVideo.style.display = 'block';
            playbackVideo.load();
            playbackVideo.play().catch(err => console.error("Autoplay prevented:", err));
        }

        playbackVideo.addEventListener('error', () => {
            playbackVideo.style.display = 'none';
            videoPlaceholder.style.display = 'block';
            videoPlaceholder.textContent = 'Video not found.';
        });

        function addDetectionToLog(word) {
            if (detectedWordsSet.has(word)) return; // Don't add duplicates
            detectedWordsSet.add(word);

            const logEntry = document.createElement('li');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            logEntry.innerHTML = `
                <div>
                    <div class="log-text">${word}</div>
                    <div class="log-time">${timestamp}</div>
                </div>
                <button class="play-log-btn" title="Play this sign">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/></svg>
                </button>
            `;
            
            logEntry.querySelector('.play-log-btn').addEventListener('click', () => playSignVideo(word));
            detectionLog.prepend(logEntry); // Add to top of the list
        }

        // --- Text-to-Sign Translator ---
        translateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const word = textInput.value.trim();
            if (word) {
                playSignVideo(word);
            }
        });

        // --- Live ISL Detection ---
        video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        });

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                webcamWrapper.classList.add('scanning');
            })
            .catch(err => {
                floatingPrediction.textContent = "Webcam Error!";
                floatingPrediction.classList.add('visible');
            });

        setInterval(async () => {
            if (video.paused || video.ended) return;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            try {
                const response = await fetch('http://localhost:7240/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData }),
                });
  
                if (!response.ok) throw new Error('Server error');

                const result = await response.json();
                
                if (result.prediction && result.prediction !== lastDetectedWord) {
                    lastDetectedWord = result.prediction;
                    floatingPrediction.textContent = result.prediction;
                    floatingPrediction.classList.add('visible');
                    addDetectionToLog(result.prediction);
                } else if (!result.prediction) {
                    lastDetectedWord = '';
                    floatingPrediction.classList.remove('visible');
                }
            } catch (error) {
                console.error("Prediction error:", error);
            }
        }, 500); // Slightly increased interval for stability
    </script>
</body>
</html>